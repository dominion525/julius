<h2>トライフォンの扱いとHMMListについて</h2>

Julius/Julian では，音素環境依存モデル（トライフォン）を音韻モデルとして用いることができます．この文書では，Julius/Julian における音素環境依存モデルの扱い方，およびトライフォンを使用する際に必要となる HMMList ファイルについて解説します．

<h3>音素環境依存モデルの判定基準</h3>

Julius は，与えられた音韻モデルが音素環境依存モデルであるかどうかを，HMM の名称パターンから判定します．HMM名の中に記号 `+', `-' が両方とも１つ以上含まれていれば，そのモデルは音素環境依存モデルとして扱われます．上記の記号が名前に全く含まれない場合，音素環境依存に関わる処理は行われません．

<h3>辞書からHMMへの対応付け</h3>

Julius の単語辞書では，単語の発音を（単）音素列で表記しています．音素環境依存モデルを使用する場合，それらは読み込み時に単語内のコンテキストを考慮したトライフォン表記に変換され，その表記に対応するHMMが割り当てられます．
<p>
モノフォンからトライフォン表記の生成は，ある音素 "X" に対して直前の音素が "L"，直後の音素が "R" である場合に "L-X+R" の形で行われます．以下は単語「英訳」のトライフォン表記への変換例です（単語の先頭・末尾については特別な処理が行われます．詳細は後述）．
<pre>
英訳+エイヤク+17        [英訳]  e     i     y     a     k     u
      ↓
英訳+エイヤク+17        [英訳]  e+i e-i+y i-y+a y-a+k a-k+u k-u
</pre>
このような "e-i+y" といった名前のトライフォンHMMが音響モデル上で一対一にすべて定義されていればよいのですが，実際には，学習時のコンテキストの扱いやモデルの共有化などにより，辞書上のすべての可能なトライフォンについてHMMが定義されていないことがあります．また音韻モデル学習時に用いたトライフォンのパターンにない音素並びが存在することもあります．
<p>
このような理由から，Julius では，<font color="red">HMMList</font>と呼ばれるファイルで，<u>単語辞書から生成されるトライフォン名と，音響モデル上のHMM名との対応を明示的に定義する</u>必要があります．
<p>
以下，このような単語辞書上の音素表記およびそれから生成される論理的なトライフォン名のことを「論理トライフォン(logical triphone)」と呼びます．またこれに対して，実際に hmmdefs で定義されているHMM名を「物理トライフォン(physical triphone)」と呼びます．

<h3>HMMListファイル</h3>

HMMListファイルは，辞書上で登場しうるすべての論理トライフォンについて，音響モデルで定義されているHMM名（物理トライフォン）を対応付けます．以下はそのフォーマットです．
<ul>
<li>一行に1つの対応を定義する．
<li>第1カラムに論理トライフォン名，第2カラムに対応する物理トライフォン（hmmdefs 内のHMM）名を指定する．
<li>第2カラムを省略した場合，論理トライフォン名と物理トライフォン名が同じ名前として登録される．
<li>重複して登録した場合，エラーとなる．
<li>すべての登場しうる論理トライフォンについて定義する必要がある．
</ul>
以下は例です．この例では，長音をコンテキストとするトライフォンを，長音でないコンテキストのトライフォンにマッピングしています．また，第２カラムが空白のエントリは，その HMM 名が直接音響モデル内で定義されていることを表します．
<pre>
a-k+a
a-k+a: a-k+a
a-k+e
a-k+e: a-k+e
a-k+i
a-k+i: a-k+i
a-k+o
a-k+o: a-k+o
a-k+u
a-k+u: a-k+u
...
</pre>
HMMList には，<u>辞書上の単語内および単語間で登場しうるすべてのトライフォンについて記述する必要がある</u>点に注意してください．単語内トライフォンで抜けがあった場合は起動時に，単語間トライフォンで抜けがあった場合は認識時にエラーとなります．
<p>
認識時には，単語内トライフォンについては辞書読み込み時に論理トライフォンから物理トライフォンへのマッピングが行われます．単語間トライフォンについては，第1パスでは，後述の "pseudo phone" を用いた近似計算が行われ，第2パスで仮説の履歴から正しい論理トライフォンを生成して割り当てます．

<h3>単語間トライフォンの扱いとPseudo phone</h3>

単語間の音素環境依存性の扱いは内部の認識処理のパスごとに異なります．第１パスでは高速化のため，単語間トライフォンについて，同じコンテキストを持つ全トライフォンHMMの尤度の上位値から近似値を求めます．例えば，前述の単語「英訳」の場合，単語の末端において， "k-u+a", "k-u+s", "k-u+e:" などの複数の物理トライフォンHMMの音響尤度を計算し，その上位候補の平均値を割り当てています（この単語間トライフォンの尤度計算方法は，実行時オプション "-iwcd1" で変えることもできます）．
<p>
この計算のために，Julius では第1パスの内部計算で，与えられた音響モデルから "k-u+*" のように同じコンテキストを持つトライフォンHMMの集合を生成し，それを "k-u" のようなバイフォンとして扱います．これを，Julius では "<font color="red">pseudo phone</font>" と呼んでいます．Pseudo phone は，同じコンテキストを持つトライフォンHMMの集合体で，それ自身が一つの論理バイフォンあるいは論理モノフォンとして扱われます．種類としては，"k-u(+*)" のように同じ中心音素と左コンテキストを持つトライフォンの集合（単語末端用），"(*-)b+e" のように同じ中心音素と右コンテキストを持つ集合（単語先頭用），および "(*-)a(+*)" のように中心音素のみ同じ集合（１音素のみからなる単語用）の3種からなります．これらは，音響モデルを読み込んだあとに，論理トライフォン名から自動的に生成されます．生成された pseudo phone は，論理トライフォンとして HMMList に追加登録されます．
<p>
pseudo phone は辞書上の単語の先頭および末尾に配置されます．第1パスでは，その集合内のすべてのトライフォンについて尤度計算を行い，スコアの高いものをその pseudo phone のスコアとして与えます．第2パスでは，単語仮説のコンテキストからただしいトライフォンに置き換えられて尤度計算されます．pseudo phone は認識中にのみ用いられるものです．
<p>
HMMList での定義は pseudo phone より優先されます．したがって，もし HMMList に "k-u" "b+e" といったバイフォンのマッピングが定義されていれば，それらについては 指定したHMMが直接，第1パスの単語先頭・末尾で使用されます．このように，HMMList 中にバイフォンやモノフォンが明示的に指定されている場合は，pseudo phone は使用されず，指定されたモデルが使用されます．
<p>

<h3>HMMListファイル作成にあたっての注意点</h3>

HMMListファイルの作成に当たっては，以下の点に注意して下さい．

<ul>
<li>HMMList ファイルでの指定は hmmdefs内の名前定義を上書きします．つま
     り，実際に hmmdefs 内で定義されている名前とマッピングの名前が重なっ
     た場合，マッピングのほうが優先されます．例を挙げると， hmmdefs 内に
<pre>
~h "j-u+q"
</pre>
という定義があるとき，HMMList ファイルで
<pre>
j-u+q y-u+q
</pre>
などど指定すると，j-u+q のHMM定義は実際には使用されずに y-u+q が使われ
ることになります．
</ul>
システムにおいて実際にどのようにマッピングされているかは，julius を "-check triphone" を付けて起動することでチェックできます．初期化終了後にチェックモードに入りプロンプトがでてきます．"H" と入力すればヘルプが出てきます．たとえば "conv" と入力した後に，音素列を入力すれば，実際にどのようなモデルが用いられるかが分かります．

<h3>補足：音響モデルの読み込み手順</h3>

logical HMM のリストは，起動時に音響モデルおよび HMMList から以下の手順で作られます．読み込み終了後は，認識処理におけるすべての HMM へのアクセスは logical HMM として行われます．
<ol>
<li>音響モデルを読み込む
<li>音響モデル上のすべてのHMM定義を physical HMM として登録
<li>if HMMListファイルが指定されていれば
  <ol>
  <li>HMMListファイルに記述されている Logical HMMを，その対応する physical HMMへのポインタとともに logical HMM として登録する．
  </ol>
   else
  <ol>
  <li>すべての physical HMM の名前をそのまま logical HMM として登録する
  </ol>
<li>上記でlogical HMM として登録されたすべてのモデル名から，pseudo phone を生成する．
<li>生成した pseudo phone を logical HMM として追加登録する．すでに logical HMM index 上に登録済みの場合は登録しない．
<li>以上．
</ol>

<hr>
<div align="right">
$Id: triphone.html,v 1.1.1.1 2007/01/10 08:01:57 kudravka_ Exp $
</div>
